import{q as we,r as u,_ as W,j as S,c as o,o as l,b as e,F,s as G,n as N,h as w,u as g,e as H,t as q,W as P,a as R,w as X,P as fe,x as xe,l as ke,y as K,z as Me,m as Se,g as B,k as he,A as be,T as Ue,p as $e,B as Ce,E as Ie,D as z,G as ve,f as Ae,H as Ee,I as Ne,J as Y}from"./app-BB0yyVeW.js";const ye=we("sidebar",()=>{const h=u(localStorage.getItem("isSidebarOpen")==="true");return{isSidebarOpen:h,toggleSidebar:()=>{h.value=!h.value,localStorage.setItem("isSidebarOpen",h.value)},setSidebar:y=>{h.value=y,localStorage.setItem("isSidebarOpen",y)}}}),je={class:"list mt-2"},De=["onClick"],Le=["src"],Oe={class:"flex-grow-1"},Te={class:"d-flex justify-content-between align-items-center"},Pe={key:0,class:"unread bg-success"},Re={key:1,class:"text-muted small mt-2"};function Be(h){if(!h)return"";try{const v=new Date(h);if(isNaN(v))return h;const s=new Date;return v.toDateString()===s.toDateString()?v.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):v.toLocaleDateString()}catch{return h}}const He={__name:"PinnedChats",props:{pinned:{type:Array,default:()=>[]},users:{type:Array,default:()=>[]},active:{type:Number,default:0},hasMessages:{type:Array,default:()=>[]},currentUserId:{type:Number,default:0}},setup(h){const v=h;console.log("pinned chats: ",JSON.stringify(v.pinned));const s=u([]),y=u([]),f=u(0),x=ye(),A=u(0);S(()=>v.currentUserId,c=>{A.value=c},{immediate:!0});function b(c=[]){const n=new Map;return(Array.isArray(c)?c:[]).forEach(t=>{var C;const k=Number(t==null?void 0:t.sender_id);if(!k)return;const $=n.get(k),U=!t.read_at;if(!$)n.set(k,{latestMessage:t,unread:U});else{U&&($.unread=!0);const j=new Date(t.created_at||0).getTime(),I=new Date(((C=$.latestMessage)==null?void 0:C.created_at)||0).getTime();j>=I&&($.latestMessage=t)}}),n}S(()=>[v.pinned,v.users,v.hasMessages,v.currentUserId],([c,n,t,k])=>{var r,d,L,T;const $=b(t),U=[],C=[],j=[],I=[],D=Number(k),O=new Set;for(const M of c){if(Number(M.id)===D)continue;const p=$.get(Number(M.id));p!=null&&p.unread?U.push({...M,snippet:((r=p.latestMessage)==null?void 0:r.message)||"",time:((d=p.latestMessage)==null?void 0:d.created_at)||"",_unread:!0}):p?C.push({...M,snippet:((L=p.latestMessage)==null?void 0:L.message)||"",time:((T=p.latestMessage)==null?void 0:T.created_at)||"",_unread:!1}):j.push({...M,snippet:"",time:"",_unread:!1}),O.add(Number(M.id))}for(const M of n){const p=Number(M.id);p===D||!p||O.has(p)||$.get(p)||(I.push({id:p,name:M.name}),O.add(p))}s.value=[...U,...C,...j],y.value=I},{immediate:!0,deep:!0}),S(()=>v.active,c=>{f.value=c},{immediate:!0});const m=c=>{P.get(route("message.viewChat",{id:c}))};return(c,n)=>(l(),o("div",null,[e("div",je,[(l(!0),o(F,null,G(s.value,t=>(l(),o("div",{key:"chat-"+t.id,onClick:k=>m(t.id),class:N(["chat-link d-flex align-items-center mb-2 p-2 rounded text-decoration-none",{active:f.value===t.id}])},[e("img",{src:t!=null&&t.profile_pic?`/storage/${t.profile_pic}`:"/images/profile.jpeg",alt:"Profile Picture",class:"rounded-circle me-2 profile-pic"},null,8,Le),e("div",Oe,[e("div",Te,[g(x).isSidebarOpen?(l(),o("strong",{key:0,class:N({"fw-bolder":t._unread})},[H(q(t.name)+" ",1),t._unread?(l(),o("small",Pe)):w("",!0)],2)):w("",!0),t._unread?(l(),o("span",Re,q(Be(t.time)),1)):w("",!0)]),e("small",{class:N(t._unread?"text-dark fw-semibold":"text-muted")},q(t.snippet),3)])],10,De))),128)),n[0]||(n[0]=e("div",{class:"extra-space-at-bottom"},null,-1))])]))}},qe=W(He,[["__scopeId","data-v-5000825c"]]),Fe={class:""},We={key:0,class:"results-wrapper"},Ve={class:"ps-0"},ze=["src"],Ke={key:1,class:"no-results"},Xe={__name:"SearchResults",props:{matchedUsers:{type:Array,default:()=>[]}},setup(h){const v=h;return(s,y)=>(l(),o("div",Fe,[v.matchedUsers.length?(l(),o("div",We,[e("ul",Ve,[(l(!0),o(F,null,G(v.matchedUsers,f=>(l(),o("li",{key:f.id,class:"mb-3"},[R(g(fe),{href:s.route("message.viewChat",{id:f==null?void 0:f.id}),class:"text-dark d-flex flex-row align-items-center text-decoration-none list py-2 px-2 rounded"},{default:X(()=>{var x;return[e("img",{src:(x=f==null?void 0:f.user_info)!=null&&x.profile_pic?`/storage/${f.user_info.profile_pic}`:"/images/profile.jpeg",class:"profile me-3",alt:"Profile pic"},null,8,ze),H(" "+q(f.name),1)]}),_:2},1032,["href"])]))),128))])])):(l(),o("div",Ke,y[0]||(y[0]=[e("p",null,"No users found.",-1)])))]))}},Ge=W(Xe,[["__scopeId","data-v-e13295e7"]]),Je={class:"main-container bg-light d-flex flex-row"},Qe={class:"d-flex justify-content-between align-items-center mb-3"},Ye={key:0,class:"text-success mb-0"},Ze={key:0,class:"input-group mb-3"},et={class:"position-relative flex-grow-1"},tt={id:"userSuggestions"},st=["value","data-id"],at={key:1,class:"text-muted"},nt={key:2,class:"mt-2 text-muted"},it={key:3,src:"/images/empty-chat.png",alt:"No pinned chats",class:"img-fluid mt-4",style:{opacity:"0.5"}},lt={class:"custom-modal-body"},ot={__name:"MessageLayout",props:{users:{type:Object,default:()=>({})},getPinned:{type:Object,default:()=>({})},activeMessage:{type:Number,default:()=>null},currentUserId:{type:Number},hasMessages:{type:Array,default:()=>[]}},setup(h){const v=ye(),s=h,y=xe(),f=u([]),x=u("");let A=u(null);const b=u([]),m=u(null);let c=u(0);const n=u([]),t=u(localStorage.getItem("isSidebarOpen")==="true"),k=u(window.innerWidth),$=ke(()=>k.value<=768),U=u(!1);K(()=>{b.value=Array.isArray(s.getPinned)?s.getPinned:Object.values(s.getPinned||{}),t.value=localStorage.getItem("isSidebarOpen")==="true",window.addEventListener("resize",()=>{k.value=window.innerWidth});const r=d=>{d.key==="Escape"&&I()};window.addEventListener("keydown",r),Me(()=>{window.removeEventListener("keydown",r)})}),S(()=>s.users,r=>{f.value=Object.entries(r||{}).map(([d,L])=>({id:d,name:L}))},{immediate:!0}),S(()=>s.currentUserId,r=>{c.value=r},{immediate:!0}),S(()=>s.getPinned,r=>{Array.isArray(r)&&(b.value=r.filter(d=>d.id!=c.value))},{immediate:!0}),S(()=>s.activeMessage,r=>{m.value=r},{immediate:!0});const C=()=>{t.value=!t.value,localStorage.setItem("isSidebarOpen",t.value),v.toggleSidebar()},j=()=>{U.value=!0,document.body.style.overflow="hidden"},I=()=>{U.value=!1,document.body.style.overflow=""},D=async()=>{try{const r=await fetch(`/message-search-v2?name=${encodeURIComponent(x.value)}`,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!r.ok)throw new Error("Network response was not ok");const d=await r.json();n.value=d.matchedUsers||[],n.value.length>0?j():alert("No users found.")}catch(r){console.error("Error fetching search results:",r)}},O=()=>{const r=document.querySelector(`#userSuggestions option[value="${x.value}"]`);r?A.value=r.getAttribute("data-id"):A.value=null};return(r,d)=>{var L,T,M;return l(),o(F,null,[R(g(Se),{title:"Message"}),e("div",Je,[t.value&&$.value?(l(),o("div",{key:0,class:"position-fixed top-0 start-0 w-100 h-100 mobile-overlay",onClick:C})):w("",!0),e("div",{class:N(["sidebar",{closed:!t.value,open:t.value}])},[e("div",Qe,[t.value?(l(),o("h5",Ye,"Messages")):w("",!0),e("div",{class:N(["flex flex-row align-center gap-2",{"flex-column justify-content-center align-items-center":!t.value}])},[e("div",null,[R(g(fe),{href:r.route("dashboard"),class:"text-dark d-flex justify-content-center align-items-center",title:"Go back"},{default:X(()=>d[2]||(d[2]=[e("i",{class:"bi bi-house back"},null,-1)])),_:1},8,["href"])]),e("div",{class:N(["bi bi-list pointer text-dark fw-bolder fs-3",{"mt-1 d-flex":!t.value}]),onClick:C},null,2)],2)]),t.value?(l(),o("div",Ze,[e("form",{onSubmit:B(D,["prevent"]),class:"search-form container-fluid d-flex align-items-center justify-content-center gap-2 py-2"},[e("div",et,[he(e("input",{type:"text",class:"form-control modern-input ps-5",placeholder:"Search users...","onUpdate:modelValue":d[0]||(d[0]=p=>x.value=p),list:"userSuggestions",onInput:O},null,544),[[be,x.value]]),d[3]||(d[3]=e("i",{class:"bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"},null,-1)),e("datalist",tt,[(l(!0),o(F,null,G(b.value,p=>(l(),o("option",{key:p.id,value:p.name,"data-id":p.id},null,8,st))),128))])]),d[4]||(d[4]=e("button",{class:"btn modern-btn px-4",type:"submit"},[e("i",{class:"bi bi-search"})],-1))],32)])):w("",!0),t.value?(l(),o("small",at,"CHATS")):w("",!0),b.value.length===0?(l(),o("div",nt," Start chatting by searching people. ")):w("",!0),R(qe,{pinned:b.value,active:m.value,hasMessages:h.hasMessages,users:f.value,currentUserId:(M=(T=(L=g(y))==null?void 0:L.props)==null?void 0:T.auth)==null?void 0:M.user.id},null,8,["pinned","active","hasMessages","users","currentUserId"]),b.value.length===0?(l(),o("img",it)):w("",!0)],2),R(Ue,{name:"modal-fade"},{default:X(()=>[U.value?(l(),o("div",{key:0,class:"custom-modal-overlay",onClick:B(I,["self"]),role:"dialog","aria-modal":"true","aria-labelledby":"matchedUsersModalLabel"},[e("div",{class:"custom-modal-dialog",onClick:d[1]||(d[1]=B(()=>{},["stop"]))},[e("header",{class:"custom-modal-header"},[d[5]||(d[5]=e("h2",{id:"matchedUsersModalLabel",class:"modal-title"},"Search Results",-1)),e("button",{"aria-label":"Close",class:"modal-close-btn",onClick:I},"âœ•")]),e("section",lt,[R(Ge,{matchedUsers:n.value},null,8,["matchedUsers"])]),e("footer",{class:"custom-modal-footer"},[e("button",{class:"modal-btn modal-btn-secondary",onClick:I},"Close")])])])):w("",!0)]),_:1}),e("main",{class:N(["right",{"sidebar-open":t.value}])},[e("div",{class:"d-flex flex-row align-items-center gap-2 d-md-none ps-2 pt-2"},[e("div",{class:"pointer text-dark fw-bolder fs-3",onClick:C},d[6]||(d[6]=[e("i",{class:"bi bi-list"},null,-1)])),d[7]||(d[7]=e("div",null,[e("p",{class:"message-text"},"Messages")],-1))]),$e(r.$slots,"default",{},void 0,!0)],2)])],64)}}},rt=W(ot,[["__scopeId","data-v-0f582958"]]),dt={key:0,class:"action-container"},ut={__name:"PopupForMessage",props:{show:Boolean,id:Number},setup(h,{expose:v}){const s=h,y=u(!1),f=u(null),x=u(0);S(()=>s.show,c=>{y.value=c},{immediate:!0}),S(()=>s.id,c=>{x.value=c},{immediate:!0}),v({root:f});const A=()=>{y.value=!1,P.post(route("message.remove",{id:x.value}),{},{onError:()=>alert("Something went wrong, please try again."),onSuccess:()=>{P.visit(route("message.index"))}})},b=()=>{y.value=!1,P.post(route("message.block",{id:x.value}),{},{onError:()=>alert("Something went wrong, please try again."),onSuccess:()=>{P.visit(route("message.index"))}})},m=()=>{P.visit(route("viewMoreUsers.index"))};return(c,n)=>(l(),o("div",{ref_key:"root",ref:f},[y.value?(l(),o("div",dt,[e("div",{class:"list"},[e("button",{type:"button",class:"d-flex align-items-center gap-2 w-100",onClick:b},n[0]||(n[0]=[e("i",{class:"bi bi-ban"},null,-1),H(" Block")])),e("button",{type:"button",class:"d-flex align-items-center gap-2 w-100 mt-2",onClick:A},n[1]||(n[1]=[e("i",{class:"bi bi-person-x"},null,-1),H(" Remove")])),n[3]||(n[3]=e("hr",null,null,-1)),e("button",{type:"button",class:"d-flex align-items-center gap-2 w-100 mt-2",onClick:m},n[2]||(n[2]=[e("i",{class:"bi bi-people"},null,-1),H(" More users")]))])])):w("",!0)],512))}},ct=W(ut,[["__scopeId","data-v-2011f163"]]),pt={class:"d-flex vh-100"},mt={class:"flex-fill d-flex flex-column"},gt={key:0,class:"d-flex align-items-center justify-content-between p-3 border-bottom bg-white"},vt={class:"d-flex align-items-center"},ft=["src"],ht={class:"d-block fw-semibold username"},bt=["onMouseenter","onMouseleave"],yt=["onClick"],_t={class:"text-muted"},wt=["onClick"],xt={key:1,class:"p-3 border-top bg-white"},kt={class:"d-flex align-items-end gap-2"},Mt=["onKeyup"],St={key:0,class:"container-fluid"},Ut={__name:"Message",props:{users:{type:Object,default:()=>({})},pinned:{type:Array,default:()=>[]},message:{type:Object,default:()=>({})},currentUserId:{type:Number,required:!0},hasMessages:{type:Array,default:()=>[]}},setup(h){const v=document.querySelector('meta[name="csrf-token"]').getAttribute("content");window.Pusher=Ce,window.Echo=new Ie({broadcaster:"pusher",key:"d05bae2705e6bccc7bcb",cluster:"ap1",forceTLS:!0,authEndpoint:"/broadcasting/auth",auth:{headers:{"X-CSRF-TOKEN":v,"X-Requested-With":"XMLHttpRequest"}}});const s=h;let y=u(!1),f=u(null),x=u([]),A=u([]),b=u([]),m=u([]),c=u(""),n=u(null),t=u(0),k=null,$=u([]),U=u(!1),C=u(!0);S(()=>s.users,i=>{x.value=i},{immediate:!0}),S(()=>s.pinned,i=>{A.value=i},{immediate:!0}),S(()=>s.message,i=>{b.value=i},{immediate:!0}),S(()=>s.currentUserId,i=>{t.value=i},{immediate:!0}),S(()=>s.hasMessages,i=>{$.value=i},{immediate:!0}),K(()=>{A.value=Array.isArray(s.pinned)?s.pinned:Object.values(s.pinned),Array.isArray(s.message.data2)&&(m.value=[...s.message.data2]),z(()=>{D()}),j(s.currentUserId)});const j=i=>{i&&(k&&(k.stopListening("NewMessageSent"),window.Echo.leave(`private-chat.${i}`)),k=window.Echo.private(`chat.${i}`).listen("NewMessageSent",a=>{m.value.push({sender_id:a.sender_id,receiver_id:a.receiver_id,message:a.message,created_at:a.created_at,id:a.id}),p(),D()}))},I=async()=>{if(c.value.trim()==="")return;const i={sender_id:t.value,receiver_id:s.message.data1.id,message:c.value,created_at:new Date().toISOString(),id:`temp_${Date.now()}`};m.value.push(i),p(),D();try{const a=await Y.post("/messages/send",{receiver_id:s.message.data1.id,content:c.value}),E=m.value.findIndex(V=>V.id===i.id);E!==-1&&(m.value[E]={...a.data},p())}catch{m.value=m.value.filter(E=>E.id!==i.id)}c.value=""},D=()=>{z(()=>{n.value&&(n.value.scrollTop=n.value.scrollHeight)})},O=()=>{y.value=!y.value};function r(i){f.value&&!f.value.$el.contains(i.target)&&(y.value=!1)}const d=async()=>{if(U.value||!C.value)return;const i=m.value[0];if(!i)return;U.value=!0;const a=n.value.scrollHeight;try{const E=await Y.post("/messages/load-older",{other_user_id:s.message.data1.id,last_message_id:i.id});E.data.length===0?C.value=!1:(m.value=[...E.data,...m.value],p(),await z(),n.value.scrollTop=n.value.scrollHeight-a)}finally{U.value=!1}},L=async i=>{try{await Y.delete("/messages/delete",{data:{message_id:i}}),m.value=m.value.filter(a=>a.id!==i),p()}catch(a){console.error("Delete failed",a)}};K(()=>{document.addEventListener("click",r),n.value.addEventListener("scroll",()=>{n.value.scrollTop===0&&d()})}),ve(()=>{document.removeEventListener("click",r)});const T=i=>{m.value.forEach(a=>{a!==i&&(a.showDelete=!1)}),i.showDelete=!i.showDelete},M=i=>{m.value.forEach(a=>{a.showDelete&&(a.showDelete=!1)})},p=()=>{m.value.sort((i,a)=>new Date(i.created_at)-new Date(a.created_at))};let J=!1;K(()=>{A.value=Array.isArray(s.pinned)?s.pinned:Object.values(s.pinned),Array.isArray(s.message.data2)&&(m.value=[...s.message.data2]),z(D),J||(j(s.currentUserId),J=!0),document.addEventListener("click",r),document.addEventListener("click",M),n.value&&n.value.addEventListener("scroll",()=>{n.value.scrollTop===0&&d()})}),ve(()=>{document.removeEventListener("click",r),document.removeEventListener("click",M),k&&(k.stopListening("NewMessageSent"),window.Echo.leave(`chat.${s.currentUserId}`))});const _e=()=>{P.visit(route("viewMoreUsers.index"))};return(i,a)=>{var E,V;return l(),Ae(rt,{users:g(x),getPinned:g(A),activeMessage:(V=(E=g(b))==null?void 0:E.data1)==null?void 0:V.id,currentUserId:g(t),hasMessages:g($)},{default:X(()=>{var Z,ee,te,se,ae,ne,ie,le,oe,re,de,ue,ce,pe,me,ge;return[e("div",pt,[e("div",mt,[(ee=(Z=g(b))==null?void 0:Z.data1)!=null&&ee.name?(l(),o("div",gt,[e("div",vt,[(ae=(se=(te=g(b))==null?void 0:te.data1)==null?void 0:se.user_info)!=null&&ae.profile_pic?(l(),o("img",{key:0,src:`/storage/${(le=(ie=(ne=g(b))==null?void 0:ne.data1)==null?void 0:ie.user_info)==null?void 0:le.profile_pic}`||"../../images/profile.jpeg",class:"rounded-circle me-2",width:"41",height:"40",style:{"max-height":"42px","min-height":"40px","max-width":"40px"}},null,8,ft)):w("",!0),e("div",null,[e("span",ht,q((re=(oe=g(b))==null?void 0:oe.data1)==null?void 0:re.name),1)])]),e("i",{class:"bi bi-three-dots-vertical fs-5 d-flex action1",onClick:B(O,["stop"])})])):w("",!0),e("div",{ref_key:"chatBox",ref:n,class:"flex-fill overflow-auto p-4 bg-light"},[(l(!0),o(F,null,G(g(m),_=>(l(),o("div",{key:_.id,class:N(["d-flex mb-2 position-relative",_.sender_id===g(t)?"justify-content-end":"justify-content-start"])},[e("div",{class:N(["message-container",_.sender_id===g(t)?"text-start":""]),onMouseenter:Q=>_.showMenu=!0,onMouseleave:Q=>_.showMenu=!1},[_.sender_id===g(t)?(l(),o("i",{key:0,class:"bi bi-three-dots-vertical message-menu-icon",onClick:B(Q=>T(_),["stop"])},null,8,yt)):w("",!0),e("div",{class:N(["message-bubble",[_.sender_id===g(t)?"bg-success text-white current_user":"bg-white chat_with"]])},q(_.message),3),e("small",_t,q(new Date(_.created_at).toLocaleTimeString()),1),_.showDelete?(l(),o("div",{key:1,class:"dropdown-delete",onClick:B(Q=>L(_.id),["stop"])}," Delete ",8,wt)):w("",!0)],42,bt)],2))),128))],512),(ue=(de=g(b))==null?void 0:de.data1)!=null&&ue.name?(l(),o("div",xt,[e("div",kt,[he(e("textarea",{"onUpdate:modelValue":a[0]||(a[0]=_=>Ne(c)?c.value=_:c=_),onInput:a[1]||(a[1]=_=>{_.target.style.height="auto",_.target.style.height=_.target.scrollHeight+"px"}),onKeyup:Ee(B(I,["exact","prevent"]),["enter"]),class:"form-control flex-grow-1 auto-resize-textarea",rows:"1",placeholder:"Type a message..."},null,40,Mt),[[be,g(c)]]),e("button",{class:"btn btn-success",onClick:I},a[2]||(a[2]=[H(" Send "),e("i",{class:"bi bi-send ms-1"},null,-1)]))])])):w("",!0)]),R(ct,{show:g(y),ref_key:"popupRef",ref:f,id:(pe=(ce=g(b))==null?void 0:ce.data1)==null?void 0:pe.id},null,8,["show","id"]),(ge=(me=g(b))==null?void 0:me.data1)!=null&&ge.name?w("",!0):(l(),o("div",St,[e("div",{class:"empty-state-container d-flex flex-column justify-content-center align-items-center position-relative"},[a[4]||(a[4]=e("div",{class:"floating-elements"},[e("div",{class:"floating-element"}),e("div",{class:"floating-element"}),e("div",{class:"floating-element"})],-1)),a[5]||(a[5]=e("img",{src:"https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4ac.svg",alt:"Select message",class:"empty-state-illustration pulse-animation"},null,-1)),a[6]||(a[6]=e("h2",{class:"empty-state-title"},"No Message Selected",-1)),a[7]||(a[7]=e("p",{class:"empty-state-subtitle"}," Select a conversation from the list or start a new one to begin messaging. ",-1)),e("button",{type:"button",class:"action-button text-dark",onClick:_e},a[3]||(a[3]=[e("i",{class:"bi bi-people-fill"},null,-1),H(" Find More Users ")]))])]))])]}),_:1},8,["users","getPinned","activeMessage","currentUserId","hasMessages"])}}},Ct=W(Ut,[["__scopeId","data-v-0d439a04"]]);export{Ct as default};
